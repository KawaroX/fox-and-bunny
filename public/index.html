<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>狐狸和小白兔</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ... 之前的样式保持不变 ... */

        #story {
            /* ... 保持之前的样式 ... */
            position: relative;
        }

        #closeStory {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #FF6A88;
            display: none;
        }

        #closeStory:hover {
            color: #ff4d6d;
        }

        .loading {
            text-align: center;
            font-style: italic;
            color: #666;
        }

        /* 添加动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fadeInUp {
            animation: fadeInUp 0.5s ease-out;
        }
    </style>
</head>
<body>
    <!-- ... 之前的 HTML 结构保持不变 ... -->
    <div class="container">
        <h1>来点故事吧 :)</h1>
        <button id="generateStory" class="primary-button">生成随机故事</button>
        <button id="toggleCustomStory" class="secondary-button">创作独特故事</button>
        <div id="customStorySection">
            <input type="text" id="customPrompt" placeholder="在草原上编织你的故事...">
            <button id="generateCustomStory" class="secondary-button">生成自定义故事</button>
        </div>
        <div id="story">
            <button id="closeStory">&times;</button>
            <div id="storyContent"></div>
        </div>
    </div>

    <script>
        const storyElement = document.getElementById('story');
        const storyContentElement = document.getElementById('storyContent');
        const generateButton = document.getElementById('generateStory');
        const toggleCustomButton = document.getElementById('toggleCustomStory');
        const customStorySection = document.getElementById('customStorySection');
        const customPromptInput = document.getElementById('customPrompt');
        const generateCustomButton = document.getElementById('generateCustomStory');
        const closeStoryButton = document.getElementById('closeStory');

        async function fetchStory(url, method = 'GET', body = null) {
            try {
                // 显示加载提示
                storyContentElement.innerHTML = '<p class="loading fadeInUp">正在编织故事，请稍候...</p>';
                storyElement.style.display = 'block';
                closeStoryButton.style.display = 'none';

                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (!data.story) {
                    throw new Error('返回的数据中没有故事');
                }
                storyContentElement.innerHTML = marked.parse(data.story);
                storyElement.classList.remove('error');
                storyContentElement.classList.add('fadeInUp');
                closeStoryButton.style.display = 'block';
            } catch (error) {
                console.error('获取故事时出错:', error);
                storyContentElement.innerHTML = '<p class="error fadeInUp">夕阳西下，故事消散了...请再次尝试编织你的故事。</p>';
                storyElement.classList.add('error');
            }
        }

        generateButton.addEventListener('click', () => fetchStory('/api/story'));

        toggleCustomButton.addEventListener('click', () => {
            customStorySection.classList.toggle('show');
        });

        generateCustomButton.addEventListener('click', () => {
            const prompt = customPromptInput.value;
            if (!prompt) {
                alert('请在草原上编织你的故事...');
                return;
            }
            fetchStory('/api/custom-story', 'POST', { prompt });
        });

        closeStoryButton.addEventListener('click', () => {
            storyElement.style.display = 'none';
            storyContentElement.innerHTML = '';
        });
    </script>
</body>
</html>